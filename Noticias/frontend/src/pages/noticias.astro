---
import Layout from '../layouts/Layout.astro';
---

<style>
	/* Estilos personalizados para Disqus - Nombres de usuario */
	#disqus_thread a.dsq-commenter-name,
	#disqus_thread .dsq-commenter-name,
	#disqus_thread .dsq-comment-header .dsq-commenter-name,
	#disqus_thread .dsq-post-author,
	#disqus_thread .dsq-author-name,
	#disqus_thread .dsq-widget-user,
	#disqus_thread .dsq-widget-meta .dsq-widget-user {
		color: #3b82f6 !important; /* Azul - puedes cambiar este color */
		font-weight: 600 !important;
		text-decoration: none !important;
		transition: color 0.2s ease !important;
	}

	/* Hover effect para nombres de usuario */
	#disqus_thread a.dsq-commenter-name:hover,
	#disqus_thread .dsq-commenter-name:hover,
	#disqus_thread .dsq-post-author:hover {
		color: #2563eb !important; /* Azul más oscuro al pasar el mouse */
		text-decoration: underline !important;
	}

	/* Modo oscuro - ajustar colores si es necesario */
	.dark #disqus_thread a.dsq-commenter-name,
	.dark #disqus_thread .dsq-commenter-name {
		color: #60a5fa !important; /* Azul más claro para modo oscuro */
	}

	.dark #disqus_thread a.dsq-commenter-name:hover,
	.dark #disqus_thread .dsq-commenter-name:hover {
		color: #93c5fd !important;
	}

	/* Aplicar estilos a todos los contenedores de Disqus */
	.disqus-container a.dsq-commenter-name,
	.disqus-container .dsq-commenter-name {
		color: #3b82f6 !important;
		font-weight: 600 !important;
	}
</style>

<Layout>
	<section class="mb-12">
		<h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Últimas Noticias</h2>
		<div id="contenedor-noticias" class="space-y-6">
			<p class="text-gray-600 dark:text-gray-400">Cargando noticias...</p>
		</div>
	</section>
</Layout>

<script>
	const API_BASE_URL = '/api';

	async function obtenerNoticias() {
		try {
			const response = await fetch(`${API_BASE_URL}/news`, {
				method: 'GET',
				headers: { 'Content-Type': 'application/json' },
			});
			if (!response.ok) throw new Error(`Error: ${response.status}`);
			return await response.json();
		} catch (error) {
			console.error('Error al obtener noticias:', error);
			throw error;
		}
	}

	function escaparHTML(texto) {
		const div = document.createElement('div');
		div.textContent = texto;
		return div.innerHTML;
	}

	function renderizarNoticias(noticias) {
		const contenedor = document.getElementById('contenedor-noticias');
		if (!contenedor) return;

		contenedor.innerHTML = '';

		if (!noticias || noticias.length === 0) {
			contenedor.innerHTML = '<p class="text-gray-600 dark:text-gray-400">No hay noticias disponibles.</p>';
			return;
		}

		noticias.forEach((noticia) => {
			const articulo = document.createElement('article');
			articulo.className = 'noticia bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow';
			articulo.setAttribute('data-id', noticia.id);

			let htmlNoticia = `
				<h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">${escaparHTML(noticia.titulo)}</h3>
				<div class="flex gap-4 text-sm text-gray-600 dark:text-gray-400 mb-3">
					<span>Por: ${escaparHTML(noticia.autor)}</span>
					<span>${noticia.fecha || 'Fecha no disponible'}</span>
				</div>
			`;

			if (noticia.imagen) {
				htmlNoticia += `
					<img src="${noticia.imagen}" alt="${escaparHTML(noticia.titulo)}" 
						 class="max-w-xs max-h-48 object-cover rounded-lg mb-4 border border-gray-200 dark:border-gray-700"
						 onerror="this.style.display='none'">
				`;
			}

			htmlNoticia += `
				<div class="text-gray-700 dark:text-gray-300 whitespace-pre-line mb-4">
					${escaparHTML(noticia.contenido)}
				</div>
				<div class="comentarios-section mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
					<h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Comentarios</h4>
					<!-- Disqus: Los comentarios se guardan automáticamente en los servidores de Disqus -->
					<!-- Cada noticia tiene su propio hilo de comentarios identificado por noticia-${noticia.id} -->
					<div id="disqus_thread-${noticia.id}" 
						 data-disqus-identifier="noticia-${noticia.id}"
						 data-disqus-title="${escaparHTML(noticia.titulo)}"
						 class="disqus-container"></div>
					<noscript>
						Por favor, habilita JavaScript para ver los comentarios de Disqus.
					</noscript>
				</div>
			`;

			articulo.innerHTML = htmlNoticia;
			contenedor.appendChild(articulo);
		});
	}

	async function cargarNoticias() {
		try {
			const noticias = await obtenerNoticias();
			renderizarNoticias(noticias);
			
			// Cargar Disqus después de renderizar las noticias
			cargarDisqus();
		} catch (error) {
			console.error('Error al cargar noticias:', error);
			const contenedor = document.getElementById('contenedor-noticias');
			if (contenedor) {
				contenedor.innerHTML = '<p class="text-red-600 dark:text-red-400">Error al cargar las noticias.</p>';
			}
		}
	}

	// Función para cargar Disqus
	// IMPORTANTE: Disqus guarda automáticamente todos los comentarios en sus servidores
	// No se guardan localmente - todo se almacena en la plataforma de Disqus
	// NO necesitas API key adicional, solo el shortname (ya configurado: 'noticiasul')
	function cargarDisqus() {
		const DISQUS_SHORTNAME = 'noticiasul';
		
		if (!DISQUS_SHORTNAME) {
			console.error('⚠️ Disqus no configurado. Configura tu shortname.');
			return;
		}

		// Esperar a que las noticias estén en el DOM
		setTimeout(() => {
			const noticias = document.querySelectorAll('[data-id]');
			if (noticias.length === 0) {
				console.warn('⚠️ No hay noticias para cargar Disqus');
				return;
			}

			// Cargar el primer hilo de Disqus
			const primeraNoticia = noticias[0];
			const primeraNoticiaId = primeraNoticia.getAttribute('data-id');
			cargarHiloDisqusSimple(primeraNoticiaId, DISQUS_SHORTNAME);
		}, 500);
	}

	// Función simple para cargar un hilo de Disqus usando el método estándar
	function cargarHiloDisqusSimple(noticiaId, shortname) {
		const disqusContainer = document.getElementById(`disqus_thread-${noticiaId}`);
		if (!disqusContainer) {
			console.error('❌ Contenedor de Disqus no encontrado:', `disqus_thread-${noticiaId}`);
			return;
		}

		// Verificar que el contenedor esté en el DOM
		if (!disqusContainer.parentNode) {
			console.error('❌ El contenedor de Disqus no está en el DOM');
			return;
		}

		const pageIdentifier = `noticia-${noticiaId}`;
		const pageUrl = `${window.location.origin}${window.location.pathname}#noticia-${noticiaId}`;
		const pageTitle = disqusContainer.getAttribute('data-disqus-title') || `Noticia ${noticiaId}`;

		// Guardar el ID original
		const originalId = disqusContainer.id;

		// Configurar Disqus ANTES de cargar el script (método estándar)
		window.disqus_config = function() {
			this.page.identifier = pageIdentifier;
			this.page.url = pageUrl;
			this.page.title = pageTitle;
		};

		// Cambiar temporalmente el ID del contenedor a 'disqus_thread' (que Disqus espera por defecto)
		disqusContainer.id = 'disqus_thread';

		// Cargar script de Disqus si no está ya cargado
		if (!document.getElementById('disqus-script')) {
			const script = document.createElement('script');
			script.id = 'disqus-script';
			script.src = `https://${shortname}.disqus.com/embed.js`;
			script.setAttribute('data-timestamp', +new Date());
			script.async = true;
			
			script.onload = function() {
				console.log('✅ Script de Disqus cargado correctamente');
				// Verificar que Disqus se inicializó correctamente
				setTimeout(() => {
					if (typeof window.DISQUS !== 'undefined') {
						console.log('✅ Disqus inicializado para:', pageIdentifier);
						// Aplicar estilos personalizados después de que Disqus cargue
						aplicarEstilosDisqus();
					} else {
						console.warn('⚠️ Disqus no se inicializó correctamente');
					}
				}, 500);
			};
			
			script.onerror = function() {
				console.error('❌ Error al cargar el script de Disqus');
				// Restaurar el ID original si hay error
				disqusContainer.id = originalId;
			};
			
			// Asegurarse de que document.body existe antes de agregar el script
			const target = document.body || document.head;
			if (target) {
				target.appendChild(script);
			} else {
				console.error('❌ No se encontró document.body ni document.head');
				disqusContainer.id = originalId;
			}
		} else {
			// Si el script ya está cargado, usar reset() para cargar el nuevo hilo
			if (typeof window.DISQUS !== 'undefined') {
				try {
					window.DISQUS.reset({
						reload: true,
						config: function() {
							this.page.identifier = pageIdentifier;
							this.page.url = pageUrl;
							this.page.title = pageTitle;
						}
					});
					console.log('✅ Disqus reseteado para:', pageIdentifier);
				} catch (error) {
					console.error('❌ Error al resetear Disqus:', error);
					disqusContainer.id = originalId;
				}
			}
		}
	}

	// Función para aplicar estilos personalizados a los nombres de usuario de Disqus
	function aplicarEstilosDisqus() {
		// Esperar a que Disqus cargue el contenido
		setTimeout(() => {
			const disqusThread = document.getElementById('disqus_thread');
			if (!disqusThread) return;

			// Crear un estilo dinámico para forzar los colores
			const styleId = 'disqus-custom-styles';
			if (!document.getElementById(styleId)) {
				const style = document.createElement('style');
				style.id = styleId;
				style.textContent = `
					#disqus_thread a.dsq-commenter-name,
					#disqus_thread .dsq-commenter-name,
					#disqus_thread .dsq-comment-header .dsq-commenter-name,
					#disqus_thread .dsq-post-author,
					#disqus_thread .dsq-author-name {
						color: #3b82f6 !important;
						font-weight: 600 !important;
						text-decoration: none !important;
					}
					#disqus_thread a.dsq-commenter-name:hover,
					#disqus_thread .dsq-commenter-name:hover {
						color: #2563eb !important;
						text-decoration: underline !important;
					}
					.dark #disqus_thread a.dsq-commenter-name,
					.dark #disqus_thread .dsq-commenter-name {
						color: #60a5fa !important;
					}
				`;
				document.head.appendChild(style);
			}

			// Aplicar estilos directamente a los elementos existentes
			const observer = new MutationObserver(() => {
				const nombres = disqusThread.querySelectorAll('.dsq-commenter-name, .dsq-post-author, .dsq-author-name');
				nombres.forEach((nombre) => {
					if (nombre.tagName === 'A') {
						nombre.style.color = document.documentElement.classList.contains('dark') ? '#60a5fa' : '#3b82f6';
						nombre.style.fontWeight = '600';
						nombre.style.textDecoration = 'none';
					}
				});
			});

			observer.observe(disqusThread, {
				childList: true,
				subtree: true
			});
		}, 1000);
	}

	document.addEventListener('DOMContentLoaded', () => {
		cargarNoticias();
	});
</script>


