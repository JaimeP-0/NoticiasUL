---
import Layout from '../layouts/Layout.astro';
import FormularioNoticia from '../components/views/FormularioNoticia.astro';
---

<Layout>
	<section class="mb-12">
		<FormularioNoticia />
	</section>
</Layout>

<script>
	const API_BASE_URL = '/api';

	// Verificar autenticaciÃ³n
	if (typeof window !== 'undefined') {
		const user = localStorage.getItem('auth_user');
		if (!user) {
			window.location.href = '/login';
		}
	}

	async function crearNoticia(datosNoticia) {
		try {
			const response = await fetch(`${API_BASE_URL}/news`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(datosNoticia),
			});
			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || `Error: ${response.status}`);
			}
			return await response.json();
		} catch (error) {
			console.error('Error al crear noticia:', error);
			throw error;
		}
	}

	async function manejarEnvioFormulario(event) {
		event.preventDefault();
		const formulario = event.target;
		const titulo = document.getElementById('titulo').value.trim();
		const contenido = document.getElementById('contenido').value.trim();
		const autor = document.getElementById('autor').value.trim();
		const imagenUrl = document.getElementById('imagen').value.trim();

		if (!titulo || !contenido || !autor) {
			alert('Por favor, completa todos los campos requeridos.');
			return;
		}

		try {
			const datosNoticia = {
				titulo,
				contenido,
				autor,
				imagen: imagenUrl || '',
			};

			await crearNoticia(datosNoticia);
			alert('Noticia creada exitosamente!');
			formulario.reset();
			window.location.href = '/noticias';
		} catch (error) {
			alert('Error al crear la noticia: ' + error.message);
			console.error(error);
		}
	}

	document.addEventListener('DOMContentLoaded', () => {
		const formulario = document.getElementById('formulario-noticia');
		if (formulario) {
			formulario.addEventListener('submit', manejarEnvioFormulario);
		}
	});
</script>

