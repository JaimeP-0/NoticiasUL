---
import Layout from '../../../layouts/Layout.astro';

export const prerender = false; // Necesitamos SSR para obtener la noticia dinámicamente

const { id, slug } = Astro.params;
let noticia = null;

// Función para generar slug desde un título
function generarSlug(texto) {
	if (!texto) return '';
	return texto
		.toString()
		.toLowerCase()
		.trim()
		.replace(/\s+/g, '-')
		.normalize('NFD')
		.replace(/[\u0300-\u036f]/g, '')
		.replace(/[^a-z0-9-]/g, '')
		.replace(/-+/g, '-')
		.replace(/^-+|-+$/g, '')
		.substring(0, 100)
		.replace(/-+$/, '');
}

if (id) {
	try {
		// Obtener noticia desde el backend
		const response = await fetch(`http://127.0.0.1:5000/api/news/${id}`);
		if (response.ok) {
			noticia = await response.json();
			
			// Verificar si el slug es correcto, si no, redirigir
			if (noticia) {
				const slugCorrecto = generarSlug(noticia.titulo);
				const slugActual = slug || '';
				
				// Si el slug no coincide, redirigir a la URL correcta
				if (slugActual !== slugCorrecto) {
					return Astro.redirect(`/noticia/${id}/${slugCorrecto}`, 301);
				}
			}
		}
	} catch (error) {
		console.error('Error al obtener noticia:', error);
	}
}

function escaparHTML(texto) {
	if (!texto) return '';
	const textoStr = String(texto);
	return textoStr
		.replace(/&/g, '&amp;')
		.replace(/</g, '&lt;')
		.replace(/>/g, '&gt;')
		.replace(/"/g, '&quot;')
		.replace(/'/g, '&#039;');
}
---

<Layout>
	{noticia ? (
		<article class="mb-12">
			<!-- Botón para volver -->
			<a 
				href="/noticias" 
				class="inline-flex items-center gap-2 text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 mb-4 transition-colors"
			>
				<i class="bi bi-arrow-left"></i>
				<span>Volver a todas las noticias</span>
			</a>

			<!-- Imagen principal -->
			{noticia.imagen && (
				<div class="w-full h-96 mb-6 rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-700">
					<img 
						src={noticia.imagen} 
						alt={noticia.titulo}
						class="w-full h-full object-cover"
					/>
				</div>
			)}

			<!-- Título -->
			<h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
				{noticia.titulo}
			</h1>

			<!-- Metadata -->
			<div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400 mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
				<span class="flex items-center gap-1">
					<i class="bi bi-person"></i>
					<span>Por: {noticia.nombre_autor || noticia.autor}</span>
				</span>
				<span class="flex items-center gap-1">
					<i class="bi bi-calendar"></i>
					<span>{noticia.fecha ? new Date(noticia.fecha).toLocaleDateString('es-ES', {
						year: 'numeric',
						month: 'long',
						day: 'numeric',
						hour: '2-digit',
						minute: '2-digit'
					}) : 'Fecha no disponible'}</span>
				</span>
			</div>

			<!-- Contenido -->
			<div class="prose dark:prose-invert max-w-none mb-8">
				<div class="text-gray-700 dark:text-gray-300 whitespace-pre-line leading-relaxed">
					{noticia.contenido}
				</div>
			</div>

			<!-- Sección de comentarios Disqus -->
			<div class="comentarios-section mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
				<h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Comentarios</h2>
				<!-- Disqus: Los comentarios se guardan automáticamente en los servidores de Disqus -->
				<!-- Cada noticia tiene su propio hilo de comentarios identificado por noticia-{id} -->
				<div 
					id="disqus_thread" 
					data-disqus-identifier={`noticia-${id}`}
					data-disqus-title={escaparHTML(noticia.titulo)}
					data-disqus-url={`${Astro.url.origin}/noticia/${id}/${slug}`}
					class="disqus-container"
				></div>
				<noscript>
					Por favor, habilita JavaScript para ver los comentarios de Disqus.
				</noscript>
			</div>
		</article>
	) : (
		<div class="text-center py-12">
			<h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Noticia no encontrada</h1>
			<p class="text-gray-600 dark:text-gray-400 mb-6">La noticia que buscas no existe o ha sido eliminada.</p>
			<a 
				href="/noticias" 
				class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
			>
				<i class="bi bi-arrow-left"></i>
				<span>Volver a noticias</span>
			</a>
		</div>
	)}
</Layout>

<style>
	/* Estilos personalizados para Disqus - Nombres de usuario */
	#disqus_thread a.dsq-commenter-name,
	#disqus_thread .dsq-commenter-name,
	#disqus_thread .dsq-comment-header .dsq-commenter-name,
	#disqus_thread .dsq-post-author,
	#disqus_thread .dsq-author-name,
	#disqus_thread .dsq-widget-user,
	#disqus_thread .dsq-widget-meta .dsq-widget-user {
		color: #3b82f6 !important;
		font-weight: 600 !important;
		text-decoration: none !important;
		transition: color 0.2s ease !important;
	}

	/* Hover effect para nombres de usuario */
	#disqus_thread a.dsq-commenter-name:hover,
	#disqus_thread .dsq-commenter-name:hover,
	#disqus_thread .dsq-post-author:hover {
		color: #2563eb !important;
		text-decoration: underline !important;
	}

	/* Modo oscuro - ajustar colores si es necesario */
	.dark #disqus_thread a.dsq-commenter-name,
	.dark #disqus_thread .dsq-commenter-name {
		color: #60a5fa !important;
	}

	.dark #disqus_thread a.dsq-commenter-name:hover,
	.dark #disqus_thread .dsq-commenter-name:hover {
		color: #93c5fd !important;
	}
</style>

<script>
	const DISQUS_SHORTNAME = 'noticiasul';
	const noticiaId = document.querySelector('[data-disqus-identifier]')?.getAttribute('data-disqus-identifier');
	const pageTitle = document.querySelector('[data-disqus-title]')?.getAttribute('data-disqus-title');
	const pageUrl = document.querySelector('[data-disqus-url]')?.getAttribute('data-disqus-url') || window.location.href;

	if (!DISQUS_SHORTNAME) {
		console.error('⚠️ Disqus no configurado. Configura tu shortname.');
	} else if (noticiaId) {
		// Configurar Disqus ANTES de cargar el script
		window.disqus_config = function() {
			this.page.identifier = noticiaId;
			this.page.url = pageUrl;
			this.page.title = pageTitle || 'Noticia';
		};

		// Cargar script de Disqus
		(function() {
			const d = document;
			const s = d.createElement('script');
			s.id = 'disqus-script';
			s.src = `https://${DISQUS_SHORTNAME}.disqus.com/embed.js`;
			s.setAttribute('data-timestamp', +new Date());
			s.async = true;
			
			s.onload = function() {
				console.log('✅ Script de Disqus cargado correctamente para:', noticiaId);
			};
			
			s.onerror = function() {
				console.error('❌ Error al cargar el script de Disqus');
			};
			
			(d.head || d.body).appendChild(s);
		})();
	}

	// Aplicar estilos personalizados después de que Disqus cargue
	function aplicarEstilosDisqus() {
		setTimeout(() => {
			const disqusThread = document.getElementById('disqus_thread');
			if (!disqusThread) return;

			const styleId = 'disqus-custom-styles';
			if (!document.getElementById(styleId)) {
				const style = document.createElement('style');
				style.id = styleId;
				style.textContent = `
					#disqus_thread a.dsq-commenter-name,
					#disqus_thread .dsq-commenter-name,
					#disqus_thread .dsq-comment-header .dsq-commenter-name,
					#disqus_thread .dsq-post-author,
					#disqus_thread .dsq-author-name {
						color: #3b82f6 !important;
						font-weight: 600 !important;
						text-decoration: none !important;
					}
					#disqus_thread a.dsq-commenter-name:hover,
					#disqus_thread .dsq-commenter-name:hover {
						color: #2563eb !important;
						text-decoration: underline !important;
					}
					.dark #disqus_thread a.dsq-commenter-name,
					.dark #disqus_thread .dsq-commenter-name {
						color: #60a5fa !important;
					}
				`;
				document.head.appendChild(style);
			}

			// Observer para aplicar estilos dinámicamente
			const observer = new MutationObserver(() => {
				const nombres = disqusThread.querySelectorAll('.dsq-commenter-name, .dsq-post-author, .dsq-author-name');
				nombres.forEach((nombre) => {
					if (nombre.tagName === 'A') {
						nombre.style.color = document.documentElement.classList.contains('dark') ? '#60a5fa' : '#3b82f6';
						nombre.style.fontWeight = '600';
						nombre.style.textDecoration = 'none';
					}
				});
			});

			observer.observe(disqusThread, {
				childList: true,
				subtree: true
			});
		}, 1000);
	}

	// Aplicar estilos cuando el DOM esté listo
	document.addEventListener('DOMContentLoaded', () => {
		aplicarEstilosDisqus();
	});
</script>

