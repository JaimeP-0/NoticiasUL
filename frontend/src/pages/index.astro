---
import Layout from '../layouts/Layout.astro';
import FormularioNoticia from '../components/FormularioNoticia.astro';
import DisqusComentarios from '../components/DisqusComentarios.astro';
---

<style>
	.app-navbar {
		background: var(--bs-body-bg);
		border-bottom: 1px solid var(--bs-border-color-translucent);
		padding: 0.5rem 0;
		margin-bottom: 0;
	}
	#reloj-actual {
		min-width: 130px;
		display: inline-block;
		text-align: end;
		font-variant-numeric: tabular-nums;
	}
	.app-menu .nav-link.active, .app-menu .nav-link:focus {
		border-bottom: 3px solid var(--bs-primary);
		color: var(--bs-primary) !important;
		background: var(--bs-secondary-bg-subtle);
	}
	.app-menu-navbar {
		background: var(--bs-body-bg);
		border-bottom: 1px solid var(--bs-border-color-translucent);
		padding-top: 0.2rem;
		padding-bottom: 0.2rem;
		margin-bottom: 1.5rem;
	}
	.app-content {
		max-width: 850px;
		background: var(--bs-body-bg);
		box-shadow: 0 2px 16px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
		border-radius: 1.0rem;
		margin: 0 auto;
	}
	#contenedor-noticias {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}
	article.noticia {
		border: 1px solid var(--bs-border-color-translucent);
		border-radius: 0.75rem;
		padding: 1.1rem 1.5rem;
		background: var(--bs-secondary-bg-subtle);
		transition: box-shadow .18s;
		box-shadow: 0 1px 4px 0 rgba(0,0,0,0.05);
	}
	article.noticia:hover {
		box-shadow: 0 6px 24px -2px rgba(0,0,0,0.11);
	}
	.noticia h3 {
		margin-top: 0;
		font-size: 1.3rem;
		color: var(--bs-primary-text-emphasis);
	}
	.noticia .autor, .noticia .fecha {
		font-size: 0.97rem;
		color: var(--bs-secondary-text-emphasis);
		display: inline-block;
		margin-right: 1em;
		margin-bottom: .15em;
	}
	.noticia img {
		max-width: 180px;
		max-height: 120px;
		object-fit: cover;
		border-radius: 0.4rem;
		display: block;
		margin-bottom: .7em;
		border: 1px solid var(--bs-border-color-translucent);
		box-shadow: 0 2px 6px 0 rgba(0,0,0,0.08);
	}
	.noticia .contenido {
		margin-top: .4em;
		white-space: pre-line;
		word-break: break-word;
	}
	section {
		padding-bottom: 1.8rem;
	}
	section:not(:last-child) {
		border-bottom: 1px solid var(--bs-border-color-translucent);
	}
	@media (max-width: 600px) {
		.app-content { padding: 9px 2px !important; border-radius: 0.4rem;}
		article.noticia { padding: .7rem .6rem; }
	}
	.app-float-button {
		box-shadow: 0 8px 34px 0 rgba(0,0,0,0.13);
	}
	.app-float-button .list-group-item {
		cursor: pointer;
		border: none;
		font-size: 1.28rem;
		padding: .3rem .9rem;
		background: none;
		transition: background .19s,color .14s;
	}
	.app-float-button .list-group-item.active {
		background: var(--bs-primary);
		color: #fff;
		border-radius: 50%;
	}
	.app-float-button .list-group-item:not(.active):hover {
		background: var(--bs-primary-bg-subtle);
		color: var(--bs-primary-text);
	}
</style>

<Layout>
	<nav class="app-navbar container-fluid d-flex flex-row align-items-center justify-content-between px-0">
		<div>
			<span class="fs-4 fw-bold" style="letter-spacing:-1px;color:var(--bs-primary)">NoticiasUL</span>
		</div>
		<div class="d-flex align-items-center gap-2" style="font-size: 1.0rem;">
			<i class="bi bi-clock"></i>
			<span id="reloj-actual"></span>
		</div>
	</nav>

	<nav class="app-menu-navbar">
		<div class="container" style="margin-bottom:0;">
			<ul id="app-menu-ul" class="app-menu nav nav-underline justify-content-center gap-2 mt-2 mb-3 mb-lg-2">
				<li class="nav-item">
					<a class="nav-link active" data-section="noticias" href="javascript:void(0)">Noticias</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-section="agregar" href="javascript:void(0)">Agregar</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-section="comentarios" href="javascript:void(0)">Comentarios</a>
				</li>
			</ul>
		</div>
	</nav>

	<div id="appContent" class="app-content container p-3 mt-2 mb-4">
		<section id="noticias" class="mb-4">
			<h2 class="h4 mb-3"><i class="bi bi-megaphone-fill me-1 text-primary"></i>Últimas Noticias</h2>
			<div id="contenedor-noticias" aria-live="polite">
				<p>Cargando noticias...</p>
			</div>
		</section>

		<section id="agregar" class="mb-4" style="display:none;">
			<h2 class="h4 mb-3"><i class="bi bi-plus-circle me-1 text-success"></i>Agregar Nueva Noticia</h2>
			<FormularioNoticia />
		</section>

		<section id="comentarios" class="mb-2" style="display:none;">
			<h2 class="h4 mb-2"><i class="bi bi-chat-text me-1 text-info"></i>Comentarios</h2>
			<DisqusComentarios />
		</section>
	</div>

	<div class="app-float-button bg-body border rounded" style="z-index: 1200; position: fixed; bottom: 16px; left: 18px;">
		<ul class="list-group list-group-horizontal m-1">
			<li class="list-group-item" data-bs-theme-value="light" title="Claro">
				<i class="bi bi-sun-fill"></i>
			</li>
			<li class="list-group-item" data-bs-theme-value="dark" title="Oscuro">
				<i class="bi bi-moon-stars-fill"></i>
			</li>
			<li class="list-group-item" data-bs-theme-value="auto" title="Auto">
				<i class="bi bi-circle-half"></i>
			</li>
		</ul>
	</div>
</Layout>

<script>
	const API_BASE_URL = '/api';

	let bootstrapTheme = localStorage.getItem('theme');

	function detectSystemTheme() {
		return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
	}

	function filterTheme(theme) {
		return theme === 'auto' ? detectSystemTheme() : theme;
	}

	function setTheme(theme) {
		document.documentElement.setAttribute('data-bs-theme', filterTheme(theme));
	}

	function showActiveTheme(theme) {
		const items = document.querySelectorAll('[data-bs-theme-value]');
		items.forEach((el) => el.classList.remove('bg-primary', 'text-white', 'active'));
		const active = document.querySelector(`[data-bs-theme-value="${theme}"]`);
		if (active) active.classList.add('bg-primary', 'text-white', 'active');
	}

	async function obtenerNoticias() {
		try {
			const response = await fetch(`${API_BASE_URL}/news`, {
				method: 'GET',
				headers: {
					'Content-Type': 'application/json'
				}
			});
			if (!response.ok) throw new Error(`Error al obtener noticias: ${response.status}`);
			const noticias = await response.json();
			return noticias;
		} catch (error) {
			console.error('Error al obtener noticias:', error);
			throw error;
		}
	}

	async function crearNoticia(datosNoticia) {
		try {
			const response = await fetch(`${API_BASE_URL}/news`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(datosNoticia)
			});
			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || `Error al crear noticia: ${response.status}`);
			}
			const resultado = await response.json();
			return resultado;
		} catch (error) {
			console.error('Error al crear noticia:', error);
			throw error;
		}
	}

	async function iniciarSesion(usuario, password) {
		try {
			const response = await fetch(`${API_BASE_URL}/login`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ usuario, password })
			});
			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || 'Credenciales incorrectas');
			}
			const resultado = await response.json();
			return resultado;
		} catch (error) {
			console.error('Error al iniciar sesión:', error);
			throw error;
		}
	}

	async function subirImagenFirebase(archivo) {
		console.log('Simulando subida de imagen a Firebase Storage...');
		return new Promise((resolve) => {
			setTimeout(() => {
				const urlSimulada = `https://firebasestorage.googleapis.com/v0/b/noticias-ul.appspot.com/o/imagenes%2F${Date.now()}_${archivo.name}?alt=media`;
				resolve(urlSimulada);
			}, 1000);
		});
	}

	function renderizarNoticias(noticias) {
		const contenedor = document.getElementById('contenedor-noticias');
		if (!contenedor) {
			console.error('Contenedor de noticias no encontrado');
			return;
		}
		contenedor.innerHTML = '';
		if (!noticias || noticias.length === 0) {
			contenedor.innerHTML = '<p>No hay noticias disponibles.</p>';
			return;
		}
		noticias.forEach(noticia => {
			const articulo = document.createElement('article');
			articulo.className = 'noticia';
			articulo.setAttribute('data-id', noticia.id);

			let htmlNoticia = `
				<div class="d-flex flex-row gap-3 align-items-start flex-wrap">
					${noticia.imagen ? `<img src="${escaparHTML(noticia.imagen)}" alt="${escaparHTML(noticia.titulo)}" style="min-width:100px;max-width:158px;" onerror="this.style.display='none'">` : ''}
					<div style="flex: 1 1 220px;">
						<h3>${escaparHTML(noticia.titulo)}</h3>
						<div class="d-flex flex-row align-items-center flex-wrap gap-2 mb-1">
							<span class="autor"><i class="bi bi-person-circle me-1"></i>${escaparHTML(noticia.autor)}</span>
							<span class="fecha"><i class="bi bi-calendar3 me-1"></i>${noticia.fecha || 'Fecha no disponible'}</span>
						</div>
						<div class="contenido">${escaparHTML(noticia.contenido)}</div>
					</div>
				</div>
			`;
			articulo.innerHTML = htmlNoticia;
			contenedor.appendChild(articulo);
		});
	}

	function escaparHTML(texto) {
		const div = document.createElement('div');
		div.textContent = texto;
		return div.innerHTML;
	}

	async function manejarEnvioFormulario(event) {
		event.preventDefault();
		const formulario = event.target;
		const titulo = document.getElementById('titulo').value.trim();
		const contenido = document.getElementById('contenido').value.trim();
		const autor = document.getElementById('autor').value.trim();
		const imagenUrl = document.getElementById('imagen').value.trim();
		if (!titulo || !contenido || !autor) {
			alert('Por favor, completa todos los campos requeridos.');
			return;
		}
		try {
			const datosNoticia = {
				titulo, contenido, autor,
				imagen: imagenUrl || ''
			};
			const resultado = await crearNoticia(datosNoticia);
			alert('Noticia creada exitosamente!');
			formulario.reset();
			await cargarNoticias();
		} catch (error) {
			alert('Error al crear la noticia: ' + error.message);
			console.error(error);
		}
	}

	async function cargarNoticias() {
		try {
			const noticias = await obtenerNoticias();
			renderizarNoticias(noticias);
		} catch (error) {
			console.error('Error al cargar noticias:', error);
			const contenedor = document.getElementById('contenedor-noticias');
			if (contenedor) {
				contenedor.innerHTML = '<p>Error al cargar las noticias. Por favor, intenta más tarde.</p>';
			}
		}
	}

	function inicializarDisqus() {
		if (typeof window !== 'undefined' && document.getElementById('disqus_thread')) {
			(function() {
				var d = document, s = d.createElement('script');
				s.src = 'https://tudominio-ejemplo.disqus.com/embed.js';
				s.setAttribute('data-timestamp', +new Date());
				(d.head || d.body).appendChild(s);
			})();
		}
	}

	function showSection(sectionId) {
		const sections = ["noticias", "agregar", "comentarios"];
		sections.forEach(id => {
			const el = document.getElementById(id);
			if (el) {
				if (id === sectionId) {
					el.style.display = '';
				} else {
					el.style.display = 'none';
				}
			}
		});
	}
	
	function setActiveMenu(sectionId) {
		const links = document.querySelectorAll('.app-menu .nav-link');
		links.forEach(link => {
			if (link.getAttribute("data-section") === sectionId) {
				link.classList.add('active');
			} else {
				link.classList.remove('active');
			}
		});
	}

	document.addEventListener('DOMContentLoaded', function() {
		bootstrapTheme = localStorage.getItem('theme') || 'auto';
		setTheme(bootstrapTheme);
		showActiveTheme(bootstrapTheme);
		document.querySelectorAll('[data-bs-theme-value]').forEach((el) => {
			el.addEventListener('click', () => {
				bootstrapTheme = el.getAttribute('data-bs-theme-value');
				localStorage.setItem('theme', bootstrapTheme);
				setTheme(bootstrapTheme);
				showActiveTheme(bootstrapTheme);
			});
		});

		const reloj = document.getElementById('reloj-actual');
		function actualizarReloj() {
			if (!reloj) return;
			const ahora = new Date();
			reloj.textContent = ahora.toLocaleString('es-ES');
		}
		actualizarReloj();
		setInterval(actualizarReloj, 1000);

		cargarNoticias();

		const formulario = document.getElementById('formulario-noticia');
		if (formulario) {
			formulario.addEventListener('submit', manejarEnvioFormulario);
		}

		inicializarDisqus();

		// Manejo de navegación de secciones
		const menuLinks = document.querySelectorAll('.app-menu .nav-link');
		menuLinks.forEach(link => {
			link.addEventListener('click', function(e) {
				e.preventDefault();
				const section = this.getAttribute("data-section");
				showSection(section);
				setActiveMenu(section);
				// Si es comentarios y hay un sistema como Disqus, podrías recargar/inicializar aquí si es necesario
			});
		});
		
		// Al inicio solo mostrar "noticias"
		showSection("noticias");

		console.log('Aplicación de Noticias Universitarias inicializada');
	});
</script>
