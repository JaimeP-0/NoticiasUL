---
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<section class="mb-12">
		<h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Administración de Usuarios</h2>
		
		<!-- Botón para agregar nuevo usuario -->
		<div class="mb-4 flex justify-between items-center">
			<p class="text-gray-600 dark:text-gray-400">Gestiona los usuarios del sistema y asigna roles.</p>
			<button id="btn-nuevo-usuario" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
				<i class="bi bi-person-plus"></i> Nuevo Usuario
			</button>
		</div>

		<!-- Tabla de usuarios -->
		<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
			<table class="w-full">
				<thead class="bg-gray-50 dark:bg-gray-700">
					<tr>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Usuario</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nombre</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Rol</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fecha Creación</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Acciones</th>
					</tr>
				</thead>
				<tbody id="tabla-usuarios" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
					<tr>
						<td colspan="6" class="px-6 py-4 text-center text-gray-600 dark:text-gray-400">Cargando usuarios...</td>
					</tr>
				</tbody>
			</table>
		</div>
	</section>

	<!-- Modal para crear/editar usuario -->
	<div id="modal-usuario" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
		<div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
			<div class="flex justify-between items-center mb-4">
				<h3 id="modal-titulo" class="text-xl font-bold text-gray-900 dark:text-white">Nuevo Usuario</h3>
				<button id="btn-cerrar-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
					<i class="bi bi-x-lg"></i>
				</button>
			</div>
			
			<form id="formulario-usuario" class="space-y-4">
				<input type="hidden" id="usuario-id" />
				
				<div>
					<label for="usuario-nombre" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
						Usuario:
					</label>
					<input
						type="text"
						id="usuario-nombre"
						name="usuario"
						required
						class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div id="div-password">
					<label for="usuario-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
						Contraseña:
					</label>
					<input
						type="password"
						id="usuario-password"
						name="password"
						required
						class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
					<p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Solo requerida para nuevos usuarios</p>
				</div>

				<div id="div-nombre-completo">
					<label for="usuario-nombre-completo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
						Nombre Completo (opcional):
					</label>
					<input
						type="text"
						id="usuario-nombre-completo"
						name="nombre"
						class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div id="div-email">
					<label for="usuario-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
						Email (opcional):
					</label>
					<input
						type="email"
						id="usuario-email"
						name="email"
						class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
					/>
				</div>

				<div>
					<label for="usuario-rol" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
						Rol:
					</label>
					<select
						id="usuario-rol"
						name="rol"
						required
						class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
					>
						<option value="usuario">Usuario</option>
						<option value="maestro">Maestro</option>
						<option value="admin">Administrador</option>
						<option value="superadmin">Super Administrador</option>
					</select>
				</div>

				<div id="usuario-error" class="text-red-600 dark:text-red-400 text-sm hidden"></div>

				<div class="flex gap-2 justify-end">
					<button
						type="button"
						id="btn-cancelar"
						class="px-4 py-2 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-900 dark:text-white font-semibold rounded-lg transition-colors"
					>
						Cancelar
					</button>
					<button
						type="submit"
						class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
					>
						Guardar
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Modal de confirmación para eliminar usuario -->
	<div id="modal-eliminar-usuario" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-50 hidden flex items-center justify-center">
		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
			<div class="p-6">
				<div class="flex items-center gap-3 mb-4">
					<div class="flex-shrink-0 w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
						<i class="bi bi-exclamation-triangle-fill text-red-600 dark:text-red-400 text-2xl"></i>
					</div>
					<h3 class="text-xl font-bold text-gray-900 dark:text-white">
						Confirmar eliminación
					</h3>
				</div>
				
				<p class="text-gray-600 dark:text-gray-300 mb-2">
					¿Estás seguro de que deseas eliminar al usuario?
				</p>
				<p id="modal-usuario-nombre" class="text-gray-900 dark:text-white font-semibold mb-6"></p>
				<p class="text-sm text-red-600 dark:text-red-400 mb-6">
					<i class="bi bi-info-circle"></i> Esta acción no se puede deshacer.
				</p>
				
				<div class="flex gap-3 justify-end">
					<button
						id="btn-cancelar-eliminar-usuario"
						class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-semibold rounded-lg transition-colors"
					>
						Cancelar
					</button>
					<button
						id="btn-confirmar-eliminar-usuario"
						class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center gap-2"
					>
						<i class="bi bi-trash"></i>
						Eliminar
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal de mensaje genérico -->
	<div id="modal-mensaje" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-50 hidden flex items-center justify-center">
		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
			<div class="p-6">
				<div class="flex items-center gap-3 mb-4">
					<div id="modal-icono" class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center">
						<i id="modal-icono-clase" class="text-2xl"></i>
					</div>
					<h3 id="modal-titulo-mensaje" class="text-xl font-bold text-gray-900 dark:text-white">
					</h3>
				</div>
				
				<p id="modal-contenido-mensaje" class="text-gray-600 dark:text-gray-300 mb-6">
				</p>
				
				<div class="flex gap-3 justify-end">
					<button
						id="btn-cerrar-mensaje"
						class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
					>
						Aceptar
					</button>
				</div>
			</div>
		</div>
	</div>
</Layout>

<script>
	const BACKEND_BASE_URL = 'http://127.0.0.1:5000/api';
	const API_BASE_URL = '/api';

	// Función para mostrar modal de mensaje
	function mostrarModalMensaje(titulo, mensaje, tipo = 'info') {
		const modal = document.getElementById('modal-mensaje');
		const tituloElement = document.getElementById('modal-titulo-mensaje');
		const contenidoElement = document.getElementById('modal-contenido-mensaje');
		const iconoElement = document.getElementById('modal-icono');
		const iconoClaseElement = document.getElementById('modal-icono-clase');
		
		if (!modal || !tituloElement || !contenidoElement) return;
		
		// Configurar según el tipo
		let bgColor, icono, iconoColor;
		switch(tipo) {
			case 'error':
				bgColor = 'bg-red-100 dark:bg-red-900/30';
				icono = 'bi-exclamation-circle-fill';
				iconoColor = 'text-red-600 dark:text-red-400';
				break;
			case 'success':
				bgColor = 'bg-green-100 dark:bg-green-900/30';
				icono = 'bi-check-circle-fill';
				iconoColor = 'text-green-600 dark:text-green-400';
				break;
			case 'warning':
				bgColor = 'bg-yellow-100 dark:bg-yellow-900/30';
				icono = 'bi-exclamation-triangle-fill';
				iconoColor = 'text-yellow-600 dark:text-yellow-400';
				break;
			default:
				bgColor = 'bg-blue-100 dark:bg-blue-900/30';
				icono = 'bi-info-circle-fill';
				iconoColor = 'text-blue-600 dark:text-blue-400';
		}
		
		iconoElement.className = `flex-shrink-0 w-12 h-12 ${bgColor} rounded-full flex items-center justify-center`;
		iconoClaseElement.className = `${icono} ${iconoColor} text-2xl`;
		tituloElement.textContent = titulo;
		contenidoElement.textContent = mensaje;
		
		modal.classList.remove('hidden');
	}

	function cerrarModalMensaje() {
		const modal = document.getElementById('modal-mensaje');
		if (modal) {
			modal.classList.add('hidden');
		}
	}

	// Variables para el modal de eliminación de usuario
	let usuarioAEliminar = null;

	function mostrarModalEliminarUsuario(id, usuario) {
		usuarioAEliminar = { id, usuario };
		const modal = document.getElementById('modal-eliminar-usuario');
		const nombreElement = document.getElementById('modal-usuario-nombre');
		
		if (modal && nombreElement) {
			nombreElement.textContent = `"${usuario}"`;
			modal.classList.remove('hidden');
		}
	}

	function cerrarModalEliminarUsuario() {
		const modal = document.getElementById('modal-eliminar-usuario');
		if (modal) {
			modal.classList.add('hidden');
			usuarioAEliminar = null;
		}
	}

	async function confirmarEliminarUsuario() {
		if (!usuarioAEliminar) return;

		const { id, usuario } = usuarioAEliminar;
		
		try {
			const response = await fetch(`${BACKEND_BASE_URL}/users/${id}`, {
				method: 'DELETE',
				headers: getAuthHeaders(),
			});

			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || 'Error al eliminar usuario');
			}

			cerrarModalEliminarUsuario();
			mostrarModalMensaje('Usuario eliminado', 'Usuario eliminado exitosamente', 'success');
			cargarUsuarios();
		} catch (error) {
			cerrarModalEliminarUsuario();
			mostrarModalMensaje('Error', error.message, 'error');
			console.error(error);
		}
	}

	// Verificar permisos
	if (typeof window !== 'undefined') {
		const role = localStorage.getItem('auth_role') || 'usuario';
		if (role !== 'superadmin') {
			document.addEventListener('DOMContentLoaded', () => {
				mostrarModalMensaje('Sin permisos', 'No tienes permisos para acceder a esta página.', 'warning');
				setTimeout(() => {
					window.location.href = '/noticias';
				}, 2000);
			});
		}
	}

	function getAuthHeaders() {
		const role = localStorage.getItem('auth_role') || 'usuario';
		return {
			'Content-Type': 'application/json',
			'X-User-Role': role
		};
	}

	function getRoleBadgeClass(rol) {
		const classes = {
			'superadmin': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
			'admin': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
			'maestro': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
			'usuario': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'
		};
		return classes[rol] || classes.usuario;
	}

	function getRoleLabel(rol) {
		const labels = {
			'superadmin': 'Super Admin',
			'admin': 'Admin',
			'maestro': 'Maestro',
			'usuario': 'Usuario'
		};
		return labels[rol] || rol;
	}

	async function obtenerUsuarios() {
		try {
			const response = await fetch(`${BACKEND_BASE_URL}/users`, {
				method: 'GET',
				headers: getAuthHeaders(),
			});
			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || `Error: ${response.status}`);
			}
			return await response.json();
		} catch (error) {
			console.error('Error al obtener usuarios:', error);
			throw error;
		}
	}

	function renderizarUsuarios(usuarios) {
		const tbody = document.getElementById('tabla-usuarios');
		if (!tbody) return;

		if (!usuarios || usuarios.length === 0) {
			tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-600 dark:text-gray-400">No hay usuarios registrados.</td></tr>';
			return;
		}

		tbody.innerHTML = usuarios.map(usuario => {
			const nombreEscapado = (usuario.nombre || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
			const emailEscapado = (usuario.email || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
			const usuarioEscapado = usuario.usuario.replace(/'/g, "\\'").replace(/"/g, '&quot;');
			
			return `
			<tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
				<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
					${usuario.usuario}
				</td>
				<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
					${usuario.nombre || '-'}
				</td>
				<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
					${usuario.email || '-'}
				</td>
				<td class="px-6 py-4 whitespace-nowrap">
					<span class="px-2 py-1 text-xs font-semibold rounded-full ${getRoleBadgeClass(usuario.rol)}">
						${getRoleLabel(usuario.rol)}
					</span>
				</td>
				<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
					${usuario.fecha_creacion ? new Date(usuario.fecha_creacion).toLocaleDateString('es-ES') : '-'}
				</td>
				<td class="px-6 py-4 whitespace-nowrap text-sm">
					<div class="flex gap-3">
						<button 
							onclick="editarUsuario(${usuario.idUsuario}, '${usuarioEscapado}', '${usuario.rol}')"
							class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
							title="Cambiar rol"
						>
							<i class="bi bi-pencil"></i>
						</button>
						<button></button>
						<button 
							onclick="eliminarUsuario(${usuario.idUsuario}, '${usuarioEscapado}')"
							class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
							title="Eliminar usuario"
						>
							<i class="bi bi-trash"></i>
						</button>
					</div>
				</td>
			</tr>
		`;
		}).join('');
	}

	async function cargarUsuarios() {
		try {
			const usuarios = await obtenerUsuarios();
			renderizarUsuarios(usuarios);
		} catch (error) {
			const tbody = document.getElementById('tabla-usuarios');
			if (tbody) {
				tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-600 dark:text-red-400">Error al cargar usuarios: ${error.message}</td></tr>`;
			}
		}
	}

	function abrirModal(esNuevo = true) {
		const modal = document.getElementById('modal-usuario');
		const titulo = document.getElementById('modal-titulo');
		const formulario = document.getElementById('formulario-usuario');
		
		if (modal) modal.classList.remove('hidden');
		if (titulo) titulo.textContent = esNuevo ? 'Nuevo Usuario' : 'Cambiar Rol de Usuario';
		if (formulario) formulario.reset();
		if (document.getElementById('usuario-id')) {
			document.getElementById('usuario-id').value = '';
		}
		if (document.getElementById('usuario-password')) {
			document.getElementById('usuario-password').required = esNuevo;
		}
		if (document.getElementById('usuario-nombre')) {
			document.getElementById('usuario-nombre').readOnly = false;
		}
		// Mostrar todos los campos al crear nuevo usuario
		if (esNuevo) {
			document.getElementById('div-password').style.display = 'block';
			document.getElementById('div-nombre-completo').style.display = 'block';
			document.getElementById('div-email').style.display = 'block';
		}
	}

	function cerrarModal() {
		const modal = document.getElementById('modal-usuario');
		if (modal) modal.classList.add('hidden');
		const errorDiv = document.getElementById('usuario-error');
		if (errorDiv) {
			errorDiv.classList.add('hidden');
			errorDiv.textContent = '';
		}
	}

	window.editarUsuario = function(id, usuario, rol) {
		document.getElementById('usuario-id').value = id;
		document.getElementById('usuario-nombre').value = usuario;
		document.getElementById('usuario-nombre').readOnly = true;
		document.getElementById('usuario-password').required = false;
		document.getElementById('div-password').style.display = 'none';
		document.getElementById('div-nombre-completo').style.display = 'none';
		document.getElementById('div-email').style.display = 'none';
		document.getElementById('usuario-rol').value = rol;
		abrirModal(false);
	};

	window.eliminarUsuario = function(id, usuario) {
		mostrarModalEliminarUsuario(id, usuario);
	};

	async function manejarEnvioFormulario(event) {
		event.preventDefault();
		const formulario = event.target;
		const errorDiv = document.getElementById('usuario-error');
		const usuarioId = document.getElementById('usuario-id').value;
		const usuario = document.getElementById('usuario-nombre').value.trim();
		const password = document.getElementById('usuario-password').value;
		const rol = document.getElementById('usuario-rol').value;

		if (!usuario || !rol) {
			if (errorDiv) {
				errorDiv.textContent = 'Por favor, completa los campos requeridos.';
				errorDiv.classList.remove('hidden');
			}
			return;
		}

		try {
			if (usuarioId) {
				// Actualizar solo el rol (no se pueden cambiar contraseñas)
				const response = await fetch(`${BACKEND_BASE_URL}/users/${usuarioId}`, {
					method: 'PUT',
					headers: getAuthHeaders(),
					body: JSON.stringify({ rol }),
				});

				if (!response.ok) {
					const errorData = await response.json();
					throw new Error(errorData.error || 'Error al actualizar rol');
				}
			} else {
				// Crear nuevo usuario
				if (!password) {
					throw new Error('La contraseña es requerida para nuevos usuarios');
				}

				const nombre = document.getElementById('usuario-nombre-completo')?.value.trim() || '';
				const email = document.getElementById('usuario-email')?.value.trim() || '';

				const response = await fetch(`${BACKEND_BASE_URL}/users`, {
					method: 'POST',
					headers: getAuthHeaders(),
					body: JSON.stringify({ usuario, password, nombre, email, rol }),
				});

				if (!response.ok) {
					const errorData = await response.json();
					throw new Error(errorData.error || 'Error al crear usuario');
				}
			}

			cerrarModal();
			cargarUsuarios();
		} catch (error) {
			if (errorDiv) {
				errorDiv.textContent = error.message || 'Error al guardar usuario';
				errorDiv.classList.remove('hidden');
			}
		}
	}

	document.addEventListener('DOMContentLoaded', () => {
		cargarUsuarios();

		// Configurar modales
		const btnCerrarMensaje = document.getElementById('btn-cerrar-mensaje');
		if (btnCerrarMensaje) {
			btnCerrarMensaje.addEventListener('click', cerrarModalMensaje);
		}

		const modalMensaje = document.getElementById('modal-mensaje');
		if (modalMensaje) {
			modalMensaje.addEventListener('click', (e) => {
				if (e.target === modalMensaje) {
					cerrarModalMensaje();
				}
			});
		}

		// Modal de eliminar usuario
		const btnCancelarEliminar = document.getElementById('btn-cancelar-eliminar-usuario');
		const btnConfirmarEliminar = document.getElementById('btn-confirmar-eliminar-usuario');
		const modalEliminarUsuario = document.getElementById('modal-eliminar-usuario');

		if (btnCancelarEliminar) {
			btnCancelarEliminar.addEventListener('click', cerrarModalEliminarUsuario);
		}

		if (btnConfirmarEliminar) {
			btnConfirmarEliminar.addEventListener('click', confirmarEliminarUsuario);
		}

		if (modalEliminarUsuario) {
			modalEliminarUsuario.addEventListener('click', (e) => {
				if (e.target === modalEliminarUsuario) {
					cerrarModalEliminarUsuario();
				}
			});
		}

		// Cerrar modales con tecla Escape
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				if (modalMensaje && !modalMensaje.classList.contains('hidden')) {
					cerrarModalMensaje();
				}
				if (modalEliminarUsuario && !modalEliminarUsuario.classList.contains('hidden')) {
					cerrarModalEliminarUsuario();
				}
			}
		});

		const btnNuevo = document.getElementById('btn-nuevo-usuario');
		const btnCerrar = document.getElementById('btn-cerrar-modal');
		const btnCancelar = document.getElementById('btn-cancelar');
		const formulario = document.getElementById('formulario-usuario');

		if (btnNuevo) {
			btnNuevo.addEventListener('click', () => {
				document.getElementById('usuario-nombre').readOnly = false;
				document.getElementById('usuario-password').required = true;
				document.getElementById('div-password').style.display = 'block';
				document.getElementById('div-nombre-completo').style.display = 'block';
				document.getElementById('div-email').style.display = 'block';
				document.getElementById('usuario-password').placeholder = '';
				abrirModal(true);
			});
		}

		if (btnCerrar) btnCerrar.addEventListener('click', cerrarModal);
		if (btnCancelar) btnCancelar.addEventListener('click', cerrarModal);
		if (formulario) formulario.addEventListener('submit', manejarEnvioFormulario);

		// Cerrar modal al hacer clic fuera
		const modal = document.getElementById('modal-usuario');
		if (modal) {
			modal.addEventListener('click', (e) => {
				if (e.target === modal) cerrarModal();
			});
		}
	});
</script>

