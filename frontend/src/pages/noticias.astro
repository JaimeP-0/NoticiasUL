---
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<section class="mb-12">
		<h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-6">Últimas Noticias</h2>
		
		<!-- Barra de búsqueda -->
		<div class="mb-6">
			<div class="relative">
				<input
					type="text"
					id="busqueda-noticias"
					placeholder="Buscar noticias por título, autor o contenido..."
					class="w-full px-4 py-3 pl-12 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
				/>
				<i class="bi bi-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 text-lg"></i>
				<button
					id="limpiar-busqueda"
					class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hidden"
					title="Limpiar búsqueda"
				>
					<i class="bi bi-x-circle text-xl"></i>
				</button>
			</div>
			<div id="resultados-busqueda" class="mt-2 text-sm text-gray-600 dark:text-gray-400 hidden"></div>
		</div>

		<div id="contenedor-noticias" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
			<p class="text-gray-600 dark:text-gray-400 col-span-full">Cargando noticias...</p>
		</div>
	</section>

	<!-- Modal de confirmación para eliminar noticia -->
	<div id="modal-eliminar" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-50 hidden flex items-center justify-center">
		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
			<div class="p-6">
				<div class="flex items-center gap-3 mb-4">
					<div class="flex-shrink-0 w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
						<i class="bi bi-exclamation-triangle-fill text-red-600 dark:text-red-400 text-2xl"></i>
					</div>
					<h3 class="text-xl font-bold text-gray-900 dark:text-white">
						Confirmar eliminación
					</h3>
				</div>
				
				<p class="text-gray-600 dark:text-gray-300 mb-2">
					¿Estás seguro de que deseas eliminar la noticia?
				</p>
				<p id="modal-titulo-noticia" class="text-gray-900 dark:text-white font-semibold mb-6 line-clamp-2"></p>
				<p class="text-sm text-red-600 dark:text-red-400 mb-6">
					<i class="bi bi-info-circle"></i> Esta acción no se puede deshacer.
				</p>
				
				<div class="flex gap-3 justify-end">
					<button
						id="btn-cancelar-eliminar"
						class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-semibold rounded-lg transition-colors"
					>
						Cancelar
					</button>
					<button
						id="btn-confirmar-eliminar"
						class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center gap-2"
					>
						<i class="bi bi-trash"></i>
						Eliminar
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal de mensaje genérico -->
	<div id="modal-mensaje" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-50 hidden flex items-center justify-center">
		<div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
			<div class="p-6">
				<div class="flex items-center gap-3 mb-4">
					<div id="modal-icono" class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center">
						<i id="modal-icono-clase" class="text-2xl"></i>
					</div>
					<h3 id="modal-titulo-mensaje" class="text-xl font-bold text-gray-900 dark:text-white">
					</h3>
				</div>
				
				<p id="modal-contenido-mensaje" class="text-gray-600 dark:text-gray-300 mb-6">
				</p>
				
				<div class="flex gap-3 justify-end">
					<button
						id="btn-cerrar-mensaje"
						class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
					>
						Aceptar
					</button>
				</div>
			</div>
		</div>
	</div>
</Layout>

<style>
	/* Estilos personalizados para las tarjetas de noticias */
	.noticia-card {
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

	.noticia-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
	}

	.noticia-card img {
		transition: transform 0.3s ease;
	}

	.noticia-card:hover img {
		transform: scale(1.05);
	}
</style>

<script>
	const API_BASE_URL = '/api';
	const BACKEND_BASE_URL = 'http://127.0.0.1:5000/api';
	const CACHE_KEY = 'noticias_cache';
	const CACHE_DURATION = 60000; // 1 minuto en milisegundos

	function getAuthHeaders() {
		const role = localStorage.getItem('auth_role') || 'usuario';
		return {
			'Content-Type': 'application/json',
			'X-User-Role': role
		};
	}

	// Función para mostrar modal de mensaje
	function mostrarModalMensaje(titulo, mensaje, tipo = 'info') {
		const modal = document.getElementById('modal-mensaje');
		const tituloElement = document.getElementById('modal-titulo-mensaje');
		const contenidoElement = document.getElementById('modal-contenido-mensaje');
		const iconoElement = document.getElementById('modal-icono');
		const iconoClaseElement = document.getElementById('modal-icono-clase');
		
		if (!modal || !tituloElement || !contenidoElement) return;
		
		// Configurar según el tipo
		let bgColor, icono, iconoColor;
		switch(tipo) {
			case 'error':
				bgColor = 'bg-red-100 dark:bg-red-900/30';
				icono = 'bi-exclamation-circle-fill';
				iconoColor = 'text-red-600 dark:text-red-400';
				break;
			case 'success':
				bgColor = 'bg-green-100 dark:bg-green-900/30';
				icono = 'bi-check-circle-fill';
				iconoColor = 'text-green-600 dark:text-green-400';
				break;
			case 'warning':
				bgColor = 'bg-yellow-100 dark:bg-yellow-900/30';
				icono = 'bi-exclamation-triangle-fill';
				iconoColor = 'text-yellow-600 dark:text-yellow-400';
				break;
			default:
				bgColor = 'bg-blue-100 dark:bg-blue-900/30';
				icono = 'bi-info-circle-fill';
				iconoColor = 'text-blue-600 dark:text-blue-400';
		}
		
		iconoElement.className = `flex-shrink-0 w-12 h-12 ${bgColor} rounded-full flex items-center justify-center`;
		iconoClaseElement.className = `${icono} ${iconoColor} text-2xl`;
		tituloElement.textContent = titulo;
		contenidoElement.textContent = mensaje;
		
		modal.classList.remove('hidden');
	}

	function cerrarModalMensaje() {
		const modal = document.getElementById('modal-mensaje');
		if (modal) {
			modal.classList.add('hidden');
		}
	}

	// Función para obtener noticias del caché o del servidor
	async function obtenerNoticias(forceRefresh = false) {
		// Verificar caché local
		if (!forceRefresh) {
			const cached = localStorage.getItem(CACHE_KEY);
			if (cached) {
				try {
					const { data, timestamp } = JSON.parse(cached);
					const now = Date.now();
					if (now - timestamp < CACHE_DURATION) {
						return data;
					}
				} catch (e) {
					// Si hay error al parsear, continuar con fetch
				}
			}
		}

		try {
			const response = await fetch(`${API_BASE_URL}/news?limit=50`, {
				method: 'GET',
				headers: { 'Content-Type': 'application/json' },
			});
			if (!response.ok) throw new Error(`Error: ${response.status}`);
			const data = await response.json();
			
			// Guardar en caché
			localStorage.setItem(CACHE_KEY, JSON.stringify({
				data,
				timestamp: Date.now()
			}));
			
			return data;
		} catch (error) {
			console.error('Error al obtener noticias:', error);
			// Intentar usar caché aunque esté expirado
			const cached = localStorage.getItem(CACHE_KEY);
			if (cached) {
				try {
					const { data } = JSON.parse(cached);
					return data;
				} catch (e) {
					// Ignorar error
				}
			}
			throw error;
		}
	}

	function escaparHTML(texto) {
		if (!texto) return '';
		const div = document.createElement('div');
		div.textContent = texto;
		return div.innerHTML;
	}

	function formatearFecha(fecha) {
		if (!fecha) return 'Fecha no disponible';
		try {
			const fechaObj = new Date(fecha);
			const dia = String(fechaObj.getDate()).padStart(2, '0');
			const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
			const año = fechaObj.getFullYear();
			return `${dia}/${mes}/${año}`;
		} catch {
			return fecha;
		}
	}

	function generarSlug(texto) {
		if (!texto) return '';
		return texto
			.toString()
			.toLowerCase()
			.trim()
			.replace(/\s+/g, '-')
			.normalize('NFD')
			.replace(/[\u0300-\u036f]/g, '')
			.replace(/[^a-z0-9-]/g, '')
			.replace(/-+/g, '-')
			.replace(/^-+|-+$/g, '')
			.substring(0, 100)
			.replace(/-+$/, '');
	}

	// Variable para almacenar todas las noticias (sin filtrar)
	let todasLasNoticias = [];

	function filtrarNoticias(terminoBusqueda) {
		if (!terminoBusqueda || terminoBusqueda.trim() === '') {
			return todasLasNoticias;
		}

		const termino = terminoBusqueda.toLowerCase().trim();
		return todasLasNoticias.filter(noticia => {
			const titulo = (noticia.titulo || '').toLowerCase();
			const autor = (noticia.nombre_autor || noticia.autor || '').toLowerCase();
			const contenido = (noticia.contenido || '').toLowerCase();
			
			return titulo.includes(termino) || 
			       autor.includes(termino) || 
			       contenido.includes(termino);
		});
	}

	function actualizarResultadosBusqueda(cantidad, total) {
		const resultadosDiv = document.getElementById('resultados-busqueda');
		if (!resultadosDiv) return;

		if (cantidad === total) {
			resultadosDiv.classList.add('hidden');
		} else {
			resultadosDiv.classList.remove('hidden');
			resultadosDiv.textContent = `Mostrando ${cantidad} de ${total} noticias`;
		}
	}

	function renderizarNoticias(noticias, mostrarResultados = false) {
		const contenedor = document.getElementById('contenedor-noticias');
		if (!contenedor) return;

		contenedor.innerHTML = '';

		if (!noticias || noticias.length === 0) {
			const mensaje = mostrarResultados 
				? '<p class="text-gray-600 dark:text-gray-400 col-span-full text-center py-8">No se encontraron noticias que coincidan con tu búsqueda.</p>'
				: '<p class="text-gray-600 dark:text-gray-400 col-span-full text-center py-8">No hay noticias disponibles.</p>';
			contenedor.innerHTML = mensaje;
			if (mostrarResultados) {
				actualizarResultadosBusqueda(0, todasLasNoticias.length);
			}
			return;
		}

		if (mostrarResultados) {
			actualizarResultadosBusqueda(noticias.length, todasLasNoticias.length);
		}

		// Verificar permisos del usuario actual
		const userRole = localStorage.getItem('auth_role') || 'usuario';
		const canDelete = userRole === 'superadmin' || userRole === 'admin';

		noticias.forEach((noticia) => {
			const tarjeta = document.createElement('article');
			tarjeta.className = 'noticia-card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden shadow-sm relative';
			tarjeta.setAttribute('data-id', noticia.id);
			
			// Hacer la tarjeta clickeable (excepto en el dropdown)
			const contenidoClickable = document.createElement('div');
			contenidoClickable.className = 'cursor-pointer';
			contenidoClickable.addEventListener('click', () => {
				const slug = generarSlug(noticia.titulo);
				window.location.href = `/noticia/${noticia.id}/${slug}`;
			});

			let htmlTarjeta = '';

			// Imagen (si existe) - lazy loading
			if (noticia.imagen) {
				htmlTarjeta += `
					<div class="w-full h-48 overflow-hidden bg-gray-200 dark:bg-gray-700">
						<img 
							src="${noticia.imagen}" 
							alt="${escaparHTML(noticia.titulo)}" 
							class="w-full h-full object-cover"
							loading="lazy"
							onerror="this.parentElement.style.display='none'"
						>
					</div>
				`;
			} else {
				// Placeholder si no hay imagen
				htmlTarjeta += `
					<div class="w-full h-48 bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center">
						<i class="bi bi-newspaper text-white text-6xl"></i>
					</div>
				`;
			}

			// Contenido de la tarjeta
			htmlTarjeta += `
				<div class="p-4">
					<div class="flex items-start justify-between mb-2">
						<h3 class="text-lg font-bold text-gray-900 dark:text-white line-clamp-2 flex-1">
							${escaparHTML(noticia.titulo)}
						</h3>
						${canDelete ? `
							<div class="relative ml-2 dropdown-container">
								<button
									class="dropdown-toggle p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
									onclick="event.stopPropagation(); toggleDropdown(${noticia.id})"
									title="Opciones"
								>
									<i class="bi bi-three-dots-vertical text-gray-600 dark:text-gray-400"></i>
								</button>
								<div
									id="dropdown-${noticia.id}"
									class="dropdown-menu hidden absolute right-0 mt-1 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-10"
								>
									<button
										onclick="event.stopPropagation(); eliminarNoticia(${noticia.id}, '${escaparHTML(noticia.titulo).replace(/'/g, "\\'")}')"
										class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2"
									>
										<i class="bi bi-trash"></i>
										<span>Eliminar noticia</span>
									</button>
								</div>
							</div>
						` : ''}
					</div>
					<div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400">
						<span class="flex items-center gap-1">
							<i class="bi bi-person"></i>
							<span>${escaparHTML(noticia.nombre_autor || noticia.autor)}</span>
						</span>
						<span class="flex items-center gap-1">
							<i class="bi bi-calendar"></i>
							<span>${formatearFecha(noticia.fecha)}</span>
						</span>
					</div>
				</div>
			`;

			contenidoClickable.innerHTML = htmlTarjeta;
			tarjeta.appendChild(contenidoClickable);
			contenedor.appendChild(tarjeta);
		});
	}

	async function cargarNoticias() {
		try {
			const noticias = await obtenerNoticias();
			todasLasNoticias = noticias; // Guardar todas las noticias para búsqueda
			renderizarNoticias(noticias);
		} catch (error) {
			console.error('Error al cargar noticias:', error);
			const contenedor = document.getElementById('contenedor-noticias');
			if (contenedor) {
				contenedor.innerHTML = '<p class="text-red-600 dark:text-red-400 col-span-full text-center py-8">Error al cargar las noticias.</p>';
			}
		}
	}

	// Función de búsqueda con debounce para optimizar
	let timeoutBusqueda = null;
	function realizarBusqueda(termino) {
		clearTimeout(timeoutBusqueda);
		timeoutBusqueda = setTimeout(() => {
			const noticiasFiltradas = filtrarNoticias(termino);
			renderizarNoticias(noticiasFiltradas, termino.trim() !== '');
		}, 300); // Esperar 300ms después de que el usuario deje de escribir
	}

	// Función para toggle del dropdown
	window.toggleDropdown = function(noticiaId) {
		// Cerrar todos los otros dropdowns
		document.querySelectorAll('.dropdown-menu').forEach(menu => {
			if (menu.id !== `dropdown-${noticiaId}`) {
				menu.classList.add('hidden');
			}
		});

		// Toggle del dropdown actual
		const dropdown = document.getElementById(`dropdown-${noticiaId}`);
		if (dropdown) {
			dropdown.classList.toggle('hidden');
		}
	};

	// Cerrar dropdowns al hacer click fuera
	document.addEventListener('click', (e) => {
		if (!e.target.closest('.dropdown-container')) {
			document.querySelectorAll('.dropdown-menu').forEach(menu => {
				menu.classList.add('hidden');
			});
		}
	});

	// Variables para el modal de eliminación
	let noticiaAEliminar = null;

	// Función para mostrar modal de confirmación
	window.eliminarNoticia = function(noticiaId, titulo) {
		noticiaAEliminar = { id: noticiaId, titulo: titulo };
		const modal = document.getElementById('modal-eliminar');
		const tituloElement = document.getElementById('modal-titulo-noticia');
		
		if (modal && tituloElement) {
			tituloElement.textContent = titulo;
			modal.classList.remove('hidden');
		}
	};

	// Función para cerrar modal
	function cerrarModalEliminar() {
		const modal = document.getElementById('modal-eliminar');
		if (modal) {
			modal.classList.add('hidden');
			noticiaAEliminar = null;
		}
	}

	// Función para confirmar eliminación
	async function confirmarEliminarNoticia() {
		if (!noticiaAEliminar) return;

		const { id, titulo } = noticiaAEliminar;
		
		try {
			const response = await fetch(`${BACKEND_BASE_URL}/news/${id}`, {
				method: 'DELETE',
				headers: getAuthHeaders()
			});

			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || 'Error al eliminar la noticia');
			}

			// Cerrar modal
			cerrarModalEliminar();

			// Eliminar del array local
			todasLasNoticias = todasLasNoticias.filter(n => n.id !== id);
			
			// Limpiar caché
			localStorage.removeItem(CACHE_KEY);
			
			// Recargar noticias
			await cargarNoticias();
			
			// Mostrar mensaje de éxito
			mostrarModalMensaje('Noticia eliminada', 'Noticia eliminada exitosamente', 'success');
		} catch (error) {
			console.error('Error al eliminar noticia:', error);
			cerrarModalEliminar();
			
			// Mostrar mensaje de error
			mostrarModalMensaje('Error', error.message, 'error');
		}
	}

	document.addEventListener('DOMContentLoaded', () => {
		cargarNoticias();

		// Configurar modal de mensaje
		const btnCerrarMensaje = document.getElementById('btn-cerrar-mensaje');
		if (btnCerrarMensaje) {
			btnCerrarMensaje.addEventListener('click', cerrarModalMensaje);
		}

		const modalMensaje = document.getElementById('modal-mensaje');
		if (modalMensaje) {
			modalMensaje.addEventListener('click', (e) => {
				if (e.target === modalMensaje) {
					cerrarModalMensaje();
				}
			});
		}

		// Configurar modal de eliminación
		const modalEliminar = document.getElementById('modal-eliminar');
		const btnCancelar = document.getElementById('btn-cancelar-eliminar');
		const btnConfirmar = document.getElementById('btn-confirmar-eliminar');

		// Cerrar modal al hacer click en cancelar
		btnCancelar?.addEventListener('click', cerrarModalEliminar);

		// Confirmar eliminación
		btnConfirmar?.addEventListener('click', confirmarEliminarNoticia);

		// Cerrar modal al hacer click fuera del contenido
		modalEliminar?.addEventListener('click', (e) => {
			if (e.target === modalEliminar) {
				cerrarModalEliminar();
			}
		});

		// Cerrar modales con tecla Escape
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				if (modalEliminar && !modalEliminar.classList.contains('hidden')) {
					cerrarModalEliminar();
				}
				if (modalMensaje && !modalMensaje.classList.contains('hidden')) {
					cerrarModalMensaje();
				}
			}
		});

		// Configurar barra de búsqueda
		const inputBusqueda = document.getElementById('busqueda-noticias');
		const btnLimpiar = document.getElementById('limpiar-busqueda');

		if (inputBusqueda) {
			// Búsqueda en tiempo real
			inputBusqueda.addEventListener('input', (e) => {
				const termino = e.target.value;
				realizarBusqueda(termino);

				// Mostrar/ocultar botón de limpiar
				if (termino.trim() !== '') {
					btnLimpiar?.classList.remove('hidden');
				} else {
					btnLimpiar?.classList.add('hidden');
					const resultadosDiv = document.getElementById('resultados-busqueda');
					if (resultadosDiv) {
						resultadosDiv.classList.add('hidden');
					}
				}
			});

			// Limpiar búsqueda
			btnLimpiar?.addEventListener('click', () => {
				inputBusqueda.value = '';
				btnLimpiar.classList.add('hidden');
				renderizarNoticias(todasLasNoticias);
				const resultadosDiv = document.getElementById('resultados-busqueda');
				if (resultadosDiv) {
					resultadosDiv.classList.add('hidden');
				}
				inputBusqueda.focus();
			});

			// Limpiar con tecla Escape
			inputBusqueda.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && inputBusqueda.value.trim() !== '') {
					inputBusqueda.value = '';
					btnLimpiar?.classList.add('hidden');
					renderizarNoticias(todasLasNoticias);
					const resultadosDiv = document.getElementById('resultados-busqueda');
					if (resultadosDiv) {
						resultadosDiv.classList.add('hidden');
					}
				}
			});
		}
	});
</script>
